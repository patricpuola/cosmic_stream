<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta charset="UTF-8">
		<style>
			html, body{
				margin: 0;
				padding: 0;
				color: gainsboro;
				background-color: rgba(0, 0, 0, 0);
				overflow: hidden;
			}

			#content{
				height: 52em;
				width: 44em;
				overflow: hidden;
			}

			#carriage{
				height: 52em;
				width: 44em;
				position: relative;
				transition: 1s all ease-in-out;
			}

			.pulled_down{
				transform: translateY(28em);
			}

			.frame{
				height: 20em;
				width: 40em;
				box-shadow: 0 0.05em 0.25em #222222, 0 0.05em 0.25em grey inset;
				display: flex;
				place-items: center;
				justify-content: space-around;
				border: 0.5em solid rgb(248, 238, 238);
				background-image: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
				padding: 0.25em;
				position: absolute;
				left: 1em;
				bottom: 2em;
				box-sizing: border-box;
				transition: 0.75s all ease-in-out;
			}

			.frame_up{
				transform: translateY(-110%) rotate(2.5deg);
			}

			img{
				max-height: 100%;
				max-width: 100%;
			}
		</style>
	</head>
	<body>
		<div id="content">
			<div id="carriage" class="pulled_down">
				<!-- Frames go here -->
			</div>
		</div>
		<script type="text/javascript" src="./config.js"></script>
		<script type="text/javascript">
			const carriage = document.getElementById('carriage');
			
			// Settings to be overwritten
			const SETTINGS = {};
			SETTINGS['frames'] = PLACEHOLDER_FRAMES;
			SETTINGS['stack_size'] = PLACEHOLDER_FRAMES.length;
			SETTINGS['display'] = DEFAULT_SETTINGS['display'];
			SETTINGS['pause'] = DEFAULT_SETTINGS['pause'];
			SETTINGS['disperse_deg'] = DEFAULT_SETTINGS['disperse_deg'];
			SETTINGS['transition_duration'] = 1000;
			SETTINGS['initial_wait'] = 100;

			function flip_card(){
				let top_frame = null;
				const frames = document.getElementsByClassName("frame");
				let highest_z = null
				for (var i = 0; i < frames.length; i++){
					if (highest_z === null || frames[i].style.zIndex > highest_z){
						top_frame = frames[i];
						highest_z = frames[i].style.zIndex;
					}
				}

				top_frame.classList.add("frame_up");
				setTimeout(function(){
					reorder_stack();
					setTimeout(function(){
						const total_dispersion = SETTINGS['disperse_deg']*2;	// e.g. +10deg => +/-5deg
						const rotation = (Math.random()*total_dispersion-total_dispersion/2).toFixed(1);
						top_frame.classList.remove("frame_up");
						if (rotation != 0){
							top_frame.style.transform = "rotate("+rotation+"deg)";
						}
					},SETTINGS['transition_duration']*0.2);
				}, SETTINGS['transition_duration']*0.8);
			}

			function clear_transformations(){
				const frames = document.getElementsByClassName("frame");
				for (var i = 0; i < frames.length; i++){
					frames[i].style.transform = null;
				}
			}

			function reorder_stack(){
				const frames = document.getElementsByClassName("frame");
				for (var i = 0; i < frames.length; i++){
					let zindex = frames[i].style.zIndex;
					frames[i].style.zIndex = ++zindex % SETTINGS['stack_size'];
				}
			}

			function perform(){
				carriage.classList.remove("pulled_down");
				var flip_counter = 0;
				var cardflip = setInterval(()=>{ // Carriage pulled up
					if (flip_counter >= SETTINGS['stack_size']-1){
						window.clearInterval(cardflip);
						carriage.classList.add("pulled_down");
						setTimeout(()=>{
							reorder_stack();
							clear_transformations();
						}, SETTINGS['transition_duration']);
					}else{
						flip_card();
						flip_counter++;
					}
				}, SETTINGS['transition_duration'] + SETTINGS['display']);
			}

			document.addEventListener("DOMContentLoaded", () => {
				const frames = [];
				const get_params = window.location.href.split(/\?(.+)/)[1];
				if (typeof get_params != 'undefined'){
					let [settings_ar, frames_ar] = get_params.split(/frames=(.+)/);
					
					settings_ar = settings_ar.split("&").filter((el) => { return el.length > 0 });
					for (var i = 0; i < settings_ar.length; i++){
						const [key, value] = settings_ar[i].split("=");
						if (value.match(/^\d+$/)){
							SETTINGS[key] = parseInt(value);
						}else{
							SETTINGS[key] = value;
						}
					}

					if (typeof frames_ar != 'undefined'){
						frames_ar = frames_ar.split(";");
						for (var i = 0; i < frames_ar.length; i++){
							const [empty, type, value] = frames_ar[i].split(/\(([^\)]+)\)/);
							frames.push({type:type, value:value});
						}
					}

					if (frames.length > 0){
						SETTINGS['frames'] = frames;
						SETTINGS['stack_size'] = frames.length;
					}
				}

				for (var i = 0; i < SETTINGS['frames'].length; i++){
					const url = SETTINGS['frames'][i].value;
					const frame = document.createElement('div');
					frame.style.zIndex = i;
					frame.classList.add('frame');
					const img = document.createElement('img');
					img.setAttribute('src', url);
					frame.appendChild(img);
					carriage.appendChild(frame);
				}				

				// display time for each frame + transition between frames + carriage movement up & down + hidden time
				const time_total_display = SETTINGS['stack_size']*SETTINGS['display'] + (SETTINGS['stack_size']+1)*SETTINGS['transition_duration'] + SETTINGS['pause'];

				setTimeout(()=>{
					perform();
					setInterval(perform, time_total_display);
				}, SETTINGS['initial_wait']);
			})
		</script>
	</body>
</html>